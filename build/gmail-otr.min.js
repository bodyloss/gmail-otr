/*! gmail-otr - v0.0.1 - 2014-01-08 */
(function(){"use strict";function a(){}function b(a,b){for(var c=a.length;c--;)if(a[c].listener===b)return c;return-1}function c(a){return function(){return this[a].apply(this,arguments)}}var d=a.prototype;d.getListeners=function(a){var b,c,d=this._getEvents();if("object"==typeof a){b={};for(c in d)d.hasOwnProperty(c)&&a.test(c)&&(b[c]=d[c])}else b=d[a]||(d[a]=[]);return b},d.flattenListeners=function(a){var b,c=[];for(b=0;b<a.length;b+=1)c.push(a[b].listener);return c},d.getListenersAsObject=function(a){var b,c=this.getListeners(a);return c instanceof Array&&(b={},b[a]=c),b||c},d.addListener=function(a,c){var d,e=this.getListenersAsObject(a),f="object"==typeof c;for(d in e)e.hasOwnProperty(d)&&-1===b(e[d],c)&&e[d].push(f?c:{listener:c,once:!1});return this},d.on=c("addListener"),d.addOnceListener=function(a,b){return this.addListener(a,{listener:b,once:!0})},d.once=c("addOnceListener"),d.defineEvent=function(a){return this.getListeners(a),this},d.defineEvents=function(a){for(var b=0;b<a.length;b+=1)this.defineEvent(a[b]);return this},d.removeListener=function(a,c){var d,e,f=this.getListenersAsObject(a);for(e in f)f.hasOwnProperty(e)&&(d=b(f[e],c),-1!==d&&f[e].splice(d,1));return this},d.off=c("removeListener"),d.addListeners=function(a,b){return this.manipulateListeners(!1,a,b)},d.removeListeners=function(a,b){return this.manipulateListeners(!0,a,b)},d.manipulateListeners=function(a,b,c){var d,e,f=a?this.removeListener:this.addListener,g=a?this.removeListeners:this.addListeners;if("object"!=typeof b||b instanceof RegExp)for(d=c.length;d--;)f.call(this,b,c[d]);else for(d in b)b.hasOwnProperty(d)&&(e=b[d])&&("function"==typeof e?f.call(this,d,e):g.call(this,d,e));return this},d.removeEvent=function(a){var b,c=typeof a,d=this._getEvents();if("string"===c)delete d[a];else if("object"===c)for(b in d)d.hasOwnProperty(b)&&a.test(b)&&delete d[b];else delete this._events;return this},d.emitEvent=function(a,b){var c,d,e,f,g=this.getListenersAsObject(a);for(e in g)if(g.hasOwnProperty(e))for(d=g[e].length;d--;)c=g[e][d],c.once===!0&&this.removeListener(a,c.listener),f=c.listener.apply(this,b||[]),f===this._getOnceReturnValue()&&this.removeListener(a,c.listener);return this},d.trigger=c("emitEvent"),d.emit=function(a){var b=Array.prototype.slice.call(arguments,1);return this.emitEvent(a,b)},d.setOnceReturnValue=function(a){return this._onceReturnValue=a,this},d._getOnceReturnValue=function(){return this.hasOwnProperty("_onceReturnValue")?this._onceReturnValue:!0},d._getEvents=function(){return this._events||(this._events={})},"function"==typeof define&&define.amd?define(function(){return a}):"object"==typeof module&&module.exports?module.exports=a:this.EventEmitter=a}).call(this),function(a,b){"function"==typeof define&&define.amd?define(["bigint","crypto","eventemitter"],function(a,c,d){var e={BigInt:a,CryptoJS:c,EventEmitter:d,OTR:{},DSA:{}};return b.call(e)}):(a.OTR={},a.DSA={},b.call(a))}(this,function(){return function(){"use strict";var a=this,b={N:"FFFFFFFFFFFFFFFFC90FDAA22168C234C4C6628B80DC1CD129024E088A67CC74020BBEA63B139B22514A08798E3404DDEF9519B3CD3A431B302B0A6DF25F14374FE1356D6D51C245E485B576625E7EC6F44C42E9A637ED6B0BFF5CB6F406B7EDEE386BFB5A899FA5AE9F24117C4B1FE649286651ECE45B3DC2007CB8A163BF0598DA48361C55D39A69163FA8FD24CF5F83655D23DCA3AD961C62F356208552BB9ED529077096966D670C354E4ABC9804F1746C08CA237327FFFFFFFFFFFFFFFF",G:"2",MSGSTATE_PLAINTEXT:0,MSGSTATE_ENCRYPTED:1,MSGSTATE_FINISHED:2,AUTHSTATE_NONE:0,AUTHSTATE_AWAITING_DHKEY:1,AUTHSTATE_AWAITING_REVEALSIG:2,AUTHSTATE_AWAITING_SIG:3,WHITESPACE_TAG:" 	  				 	 	 	  ",WHITESPACE_TAG_V2:"  		  	 ",WHITESPACE_TAG_V3:"  		  		",OTR_TAG:"?OTR",OTR_VERSION_1:"\x00",OTR_VERSION_2:"\x00",OTR_VERSION_3:"\x00",SMPSTATE_EXPECT0:0,SMPSTATE_EXPECT1:1,SMPSTATE_EXPECT2:2,SMPSTATE_EXPECT3:3,SMPSTATE_EXPECT4:4,STATUS_SEND_QUERY:0,STATUS_AKE_INIT:1,STATUS_AKE_SUCCESS:2,STATUS_END_OTR:3};"undefined"!=typeof module&&module.exports?module.exports=b:a.OTR.CONST=b}.call(this),function(){"use strict";var a,b,c=this,d={};"undefined"!=typeof module&&module.exports?(module.exports=d={},a=require("../vendor/crypto.js"),b=require("../vendor/bigint.js")):(c.OTR&&(c.OTR.HLP=d),c.DSA&&(c.DSA.HLP=d),a=c.CryptoJS,b=c.BigInt);var e={BYTE:1,SHORT:2,INT:4,CTR:8,MAC:20,SIG:40},f="?OTR",g=".",h=b.str2bigInt("2",10);d.debug=function(a){this.debug&&"function"!=typeof this.debug&&"undefined"!=typeof console&&console.log(a)},d.extend=function(a,b){function c(){this.constructor=a}for(var d in b)Object.hasOwnProperty.call(b,d)&&(a[d]=b[d]);c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype},d.compare=function(a,b){if(a.length!==b.length)return!1;for(var c=0,d=0;c<a.length;c++)d|=a[c].charCodeAt(0)^b[c].charCodeAt(0);return 0===d},d.randomExponent=function(){return b.randBigInt(1536)},d.smpHash=function(b,c,f){var g=a.algo.SHA256.create();g.update(a.enc.Latin1.parse(d.packBytes(b,e.BYTE))),g.update(a.enc.Latin1.parse(d.packMPI(c))),f&&g.update(a.enc.Latin1.parse(d.packMPI(f)));var h=g.finalize();return d.bits2bigInt(h.toString(a.enc.Latin1))},d.makeMac=function(b,c){var e=a.enc.Latin1.parse(c),f=a.HmacSHA256(a.enc.Latin1.parse(b),e);return d.mask(f.toString(a.enc.Latin1),0,160)},d.make1Mac=function(b,c){var d=a.enc.Latin1.parse(c),e=a.HmacSHA1(a.enc.Latin1.parse(b),d);return e.toString(a.enc.Latin1)},d.encryptAes=function(b,c,d){var e={mode:a.mode.CTR,iv:a.enc.Latin1.parse(d),padding:a.pad.NoPadding},f=a.AES.encrypt(b,a.enc.Latin1.parse(c),e),g=a.enc.Base64.parse(f.toString());return a.enc.Latin1.stringify(g)},d.decryptAes=function(b,c,d){b=a.enc.Latin1.parse(b);var e={mode:a.mode.CTR,iv:a.enc.Latin1.parse(d),padding:a.pad.NoPadding};return a.AES.decrypt(a.enc.Base64.stringify(b),a.enc.Latin1.parse(c),e)},d.multPowMod=function(a,c,d,e,f){return b.multMod(b.powMod(a,c,f),b.powMod(d,e,f),f)},d.ZKP=function(a,c,e,f){return b.equals(c,d.smpHash(a,e,f))},d.GTOE=function(a,c){return b.equals(a,c)||b.greater(a,c)},d.between=function(a,c,d){return b.greater(a,c)&&b.greater(d,a)},d.checkGroup=function(a,b){return d.GTOE(a,h)&&d.GTOE(b,a)},d.h1=function(b,c){var d=a.algo.SHA1.create();return d.update(a.enc.Latin1.parse(b)),d.update(a.enc.Latin1.parse(c)),d.finalize().toString(a.enc.Latin1)},d.h2=function(b,c){var d=a.algo.SHA256.create();return d.update(a.enc.Latin1.parse(b)),d.update(a.enc.Latin1.parse(c)),d.finalize().toString(a.enc.Latin1)},d.mask=function(a,b,c){return a.substr(b/8,c/8)};var i=String.fromCharCode;d.packBytes=function(a,b){a=a.toString(16);for(var c,d="";b>0;b--)c=a.length?a.substr(-2,2):"0",a=a.substr(0,a.length-2),d=i(parseInt(c,16))+d;return d},d.packINT=function(a){return d.packBytes(a,e.INT)},d.packCtr=function(a){return d.padCtr(d.packBytes(a,e.CTR))},d.padCtr=function(a){return a+"\x00\x00\x00\x00\x00\x00\x00\x00"},d.unpackCtr=function(a){return a=d.toByteArray(a.substring(0,8)),d.unpack(a)},d.unpack=function(a){for(var b=0,c=0,d=a.length;d>c;c++)b=256*b+a[c];return b},d.packData=function(a){return d.packINT(a.length)+a},d.bits2bigInt=function(a){return a=d.toByteArray(a),b.ba2bigInt(a)},d.packMPI=function(a){return d.packData(b.bigInt2bits(b.trim(a,0)))},d.packSHORT=function(a){return d.packBytes(a,e.SHORT)},d.unpackSHORT=function(a){return a=d.toByteArray(a),d.unpack(a)},d.packTLV=function(a,b){return d.packSHORT(a)+d.packSHORT(b.length)+b},d.readLen=function(a){return a=d.toByteArray(a.substring(0,4)),d.unpack(a)},d.readData=function(a){var b=d.unpack(a.splice(0,4));return[b,a]},d.readMPI=function(a){return a=d.toByteArray(a),a=d.readData(a),b.ba2bigInt(a[1])},d.packMPIs=function(a){return a.reduce(function(a,b){return a+d.packMPI(b)},"")},d.unpackMPIs=function(a,b){for(var c=0,e=[];a>c;c++)e.push("MPI");return d.splitype(e,b).map(function(a){return d.readMPI(a)})},d.wrapMsg=function(b,c,e,h,i){b=a.enc.Base64.stringify(a.enc.Latin1.parse(b)),b=f+":"+b+g;var j;if(e&&(j="|",j+=d.readLen(h).toString(16),j+="|",j+=d.readLen(i).toString(16)),!c)return[null,b];var k=Math.ceil(b.length/c);if(k>65535)return["Too many fragments"];if(1==k)return[null,b];var l,m,n,o,p,q=[];for(l=1;k>=l;l++)m=(l-1)*c,n=l*c,o=b.slice(m,n),p=f,e&&(p+=j),p+=","+l+",",p+=k+",",p+=o+",",q.push(p);return[null,q]},d.splitype=function k(a,b){var c=[];return a.forEach(function(a){var f;switch(a){case"PUBKEY":f=k(["SHORT","MPI","MPI","MPI","MPI"],b).join("");break;case"DATA":case"MPI":f=b.substring(0,d.readLen(b)+4);break;default:f=b.substring(0,e[a])}c.push(f),b=b.substring(f.length)}),c};var j=function(){for(var a=0,b={};256>a;++a)b[String.fromCharCode(a)]=a;for(a=128;256>a;++a)b[String.fromCharCode(63232+a)]=a;return b}();d.toByteArray=function(a){for(var b=[],c=a.split(""),d=-1,e=c.length,f=e%8;f--;)++d,b[d]=j[c[d]];for(f=e>>3;f--;)b.push(j[c[++d]],j[c[++d]],j[c[++d]],j[c[++d]],j[c[++d]],j[c[++d]],j[c[++d]],j[c[++d]]);return b}}.call(this),function(){"use strict";function a(){var a=(new Date).getTime();return function(b){if(r&&"undefined"!=typeof console){var c=(new Date).getTime();console.log(b+": "+(c-a)),a=c}}}function b(a,c){var d=i.randBigInt(i.bitSize(c));return l.between(d,a,c)?d:b(a,c)}function c(a,b){var c,d=3e4,e=i.bitSize(a),f=i.primes;for(0===f.length&&(f=i.findPrimes(d)),s.length!=a.length&&(s=i.dup(a)),c=0;c<f.length&&f[c]<=d;c++)if(0===i.modInt(a,f[c])&&!i.equalsInt(a,f[c]))return 0;for(c=0;b>c;c++){for(i.randBigInt_(s,e,0);!i.greater(a,s);)i.randBigInt_(s,e,0);if(!i.millerRabin(a,s))return 0}return 1}function d(b){for(var d,e,f,g,h=a(),j=t[b].repeat,k=t[b].N,l=i.twoToThe(b-1),m=4*b,n=!1;;)if(d=i.randBigInt(k,1),d[0]|=1,c(d,j)){for(h("q"),g=0;m>g;g++)if(e=i.randBigInt(b,1),e[0]|=1,f=i.mod(e,d),f=i.sub(f,o),e=i.sub(e,f),!i.greater(l,e)&&c(e,j)){h("p"),u[b]={p:e,q:d},n=!0;break}if(n)break}for(var q,r=i.dup(p),s=i.sub(e,o),v=i.multMod(s,i.inverseMod(d,e),e);;){q=i.powMod(r,v,e);{if(!i.equals(q,o))return u[b].g=q,h("g"),void 0;r=i.add(r,o)}}throw new Error("Unreachable!")}function e(a,c){if(!(this instanceof e))return new e(a,c);if(c=c||{},a){var f=this;return["p","q","g","y","x"].forEach(function(b){f[b]=a[b]}),this.type=a.type||q,void 0}var g=parseInt(c.bit_length?c.bit_length:1024,10);if(!t[g])throw new Error("Unsupported bit length.");u[g]||d(g),this.p=u[g].p,this.q=u[g].q,this.g=u[g].g,this.type=q,this.x=b(n,this.q),this.y=i.powMod(this.g,this.x,this.p),c.nocache&&(u[g]=null)}function f(a){var b,c;if(b=a.indexOf("("),c=a.lastIndexOf(")"),0>b||0>c)throw new Error("Malformed S-Expression");a=a.substring(b+1,c);var d=a.search(/\s/),e={type:a.substring(0,d),val:[]};if(a=a.substring(d+1,c),b=a.indexOf("("),0>b)e.val.push(a);else for(var g,h,i,j;b>-1;){for(g=b+1,h=a.length,i=1,j=0;h>g&&i>j;g++)"("===a[g]&&i++,")"===a[g]&&j++;e.val.push(f(a.substring(b,++g))),a=a.substring(++g),b=a.indexOf("(")}return e}function g(a){if(!a.type)throw new Error("Parse error.");var b,c;return"privkeys"===a.type?(b=[],a.val.forEach(function(a){b.push(g(a))}),b):(b={},a.val.forEach(function(a){c=a.val[0],"string"==typeof c?0===c.indexOf("#")&&(c=c.substring(1,c.lastIndexOf("#")),c=i.str2bigInt(c,16)):c=g(a),b[a.type]=c}),b)}var h,i,j,k,l,m=this;"undefined"!=typeof module&&module.exports?(module.exports=e,h=require("../vendor/crypto.js"),i=require("../vendor/bigint.js"),k=require("path").join(__dirname,"/dsa-webworker.js"),l=require("./helpers.js")):(Object.keys(m.DSA).forEach(function(a){e[a]=m.DSA[a]}),m.DSA=e,h=m.CryptoJS,i=m.BigInt,j=m.Worker,k="dsa-webworker.js",l=e.HLP);var n=i.str2bigInt("0",10),o=i.str2bigInt("1",10),p=i.str2bigInt("2",10),q="\x00\x00",r=!1,s=[],t={1024:{N:160,repeat:40},2048:{N:224,repeat:56}},u={};e.prototype={constructor:e,packPublic:function(){var a=this.type;return a+=l.packMPI(this.p),a+=l.packMPI(this.q),a+=l.packMPI(this.g),a+=l.packMPI(this.y)},packPrivate:function(){var a=this.packPublic()+l.packMPI(this.x);return a=h.enc.Latin1.parse(a),a.toString(h.enc.Base64)},generateNonce:function(a){var b=i.bigInt2bits(i.trim(this.x,0)),c=i.bigInt2bits(i.randBigInt(256)),d=h.algo.SHA256.create();d.update(h.enc.Latin1.parse(b)),d.update(a),d.update(h.enc.Latin1.parse(c));var e=d.finalize();return e=l.bits2bigInt(e.toString(h.enc.Latin1)),i.rightShift_(e,256-i.bitSize(this.q)),l.between(e,n,this.q)?e:this.generateNonce(a)},sign:function(a){a=h.enc.Latin1.parse(a);for(var b,c=i.str2bigInt(a.toString(h.enc.Hex),16),d=n,e=n;i.isZero(e)||i.isZero(d);)b=this.generateNonce(a),d=i.mod(i.powMod(this.g,b,this.p),this.q),i.isZero(d)||(e=i.inverseMod(b,this.q),e=i.mult(e,i.add(c,i.mult(this.x,d))),e=i.mod(e,this.q));return[d,e]},fingerprint:function(){var a=this.packPublic();return this.type===q&&(a=a.substring(2)),a=h.enc.Latin1.parse(a),h.SHA1(a).toString(h.enc.Hex)}},e.parsePublic=function(a,b){var c=["SHORT","MPI","MPI","MPI","MPI"];b&&c.push("MPI"),a=l.splitype(c,a);var d={type:a[0],p:l.readMPI(a[1]),q:l.readMPI(a[2]),g:l.readMPI(a[3]),y:l.readMPI(a[4])};return b&&(d.x=l.readMPI(a[5])),new e(d)},e.parsePrivate=function(a,b){return b?g(f(a))[0]["private-key"].dsa:(a=h.enc.Base64.parse(a),a=a.toString(h.enc.Latin1),e.parsePublic(a,!0))},e.verify=function(a,b,c,d){if(!l.between(c,n,a.q)||!l.between(d,n,a.q))return!1;var e=h.enc.Latin1.parse(b);e=i.str2bigInt(e.toString(h.enc.Hex),16);var f=i.inverseMod(d,a.q),g=i.multMod(e,f,a.q),j=i.multMod(c,f,a.q);g=i.powMod(a.g,g,a.p),j=i.powMod(a.y,j,a.p);var k=i.mod(i.multMod(g,j,a.p),a.q);return i.equals(k,c)},e.createInWebWorker=function(a,b){var c={path:k,seed:i.getSeed};a&&"object"==typeof a&&Object.keys(a).forEach(function(b){c[b]=a[b]}),"undefined"!=typeof module&&module.exports&&(j=require("webworker-threads").Worker);var d=new j(c.path);d.onmessage=function(a){var c=a.data;switch(c.type){case"debug":if(!r||"undefined"==typeof console)return;console.log(c.val);break;case"data":d.terminate(),b(e.parsePrivate(c.val));break;default:throw new Error("Unrecognized type.")}},d.postMessage({seed:c.seed(),imports:c.imports,debug:r})}}.call(this),function(){"use strict";var a,b,c,d=this,e={};"undefined"!=typeof module&&module.exports?(module.exports=e,a=require("../vendor/crypto.js"),b=require("./const.js"),c=require("./helpers.js")):(d.OTR.Parse=e,a=d.CryptoJS,b=d.OTR.CONST,c=d.OTR.HLP);var f={};f[b.WHITESPACE_TAG_V2]=b.OTR_VERSION_2,f[b.WHITESPACE_TAG_V3]=b.OTR_VERSION_3,e.parseMsg=function(d,e){var g=[],h=e.indexOf(b.OTR_TAG);if(!~h){if(this.initFragment(d),k=e.indexOf(b.WHITESPACE_TAG),~k){e=e.split(""),e.splice(k,16);for(var i,j=e.length;j>k;)i=e.slice(k,k+8).join(""),Object.hasOwnProperty.call(f,i)?(e.splice(k,8),g.push(f[i])):k+=8;e=e.join("")}return{msg:e,ver:g}}var k=h+b.OTR_TAG.length,l=e[k];if(","===l||"|"===l)return this.msgFragment(d,e.substring(k+1),"|"===l);if(this.initFragment(d),~["?","v"].indexOf(l)){"?"===e[k]&&(g.push(b.OTR_VERSION_1),k+=1);var m={2:b.OTR_VERSION_2,3:b.OTR_VERSION_3},n=e.substring(k+1),o=n.indexOf("?");return o>=1&&(n=n.substring(0,o).split(""),"v"===e[k]&&n.forEach(function(a){Object.hasOwnProperty.call(m,a)&&g.push(m[a])})),{cls:"query",ver:g}}if(":"===l){k+=1;var p=e.substring(k,k+4);if(p.length<4)return{msg:e};p=a.enc.Base64.parse(p).toString(a.enc.Latin1);var q=p.substring(0,2),r=p.substring(2);if(!d["ALLOW_V"+c.unpackSHORT(q)])return{msg:e};k+=4;var s=e.substring(k).indexOf(".");if(!~s)return{msg:e};e=a.enc.Base64.parse(e.substring(k,k+s)),e=a.enc.Latin1.stringify(e);var t;q===b.OTR_VERSION_3&&(t=e.substring(0,8),e=e.substring(8));var u;return~["","\n","",""].indexOf(r)?u="ake":""===r&&(u="data"),{version:q,type:r,msg:e,cls:u,instance_tags:t}}return" Error:"===e.substring(k,k+7)?(d.ERROR_START_AKE&&d.sendQueryMsg(),{msg:e.substring(k+7),cls:"error"}):{msg:e}},e.initFragment=function(a){a.fragment={s:"",j:0,k:0}},e.msgFragment=function(a,b,d){if(b=b.split(","),d){var e=b.shift().split("|"),f=c.packINT(parseInt(e[0],16)),g=c.packINT(parseInt(e[1],16));if(a.checkInstanceTags(f+g))return}if(!(b.length<4||isNaN(parseInt(b[0],10))||isNaN(parseInt(b[1],10)))){var h=parseInt(b[0],10),i=parseInt(b[1],10);return b=b[2],h>i||0===i||0===h?(this.initFragment(a),void 0):(1===h?(this.initFragment(a),a.fragment={k:1,n:i,s:b}):i===a.fragment.n&&h===a.fragment.k+1?(a.fragment.s+=b,a.fragment.k+=1):this.initFragment(a),i===h?(b=a.fragment.s,this.initFragment(a),this.parseMsg(a,b)):void 0)}}}.call(this),function(){"use strict";function a(a,b,d,e,g){var h=c.enc.Latin1.parse(g),i=c.algo.HMAC.create(c.algo.SHA256,h);return i.update(c.enc.Latin1.parse(f.packMPI(a))),i.update(c.enc.Latin1.parse(f.packMPI(b))),i.update(c.enc.Latin1.parse(d)),i.update(c.enc.Latin1.parse(e)),i.finalize().toString(c.enc.Latin1)}function b(a){if(!(this instanceof b))return new b(a);this.otr=a,this.our_dh=a.our_old_dh,this.our_keyid=a.our_keyid-1,this.their_y=null,this.their_keyid=null,this.their_priv_pk=null,this.ssid=null,this.transmittedRS=!1,this.r=null,this.priv=a.priv;var c=this;["sendMsg"].forEach(function(a){c[a]=c[a].bind(c)})}var c,d,e,f,g,h=this;"undefined"!=typeof module&&module.exports?(module.exports=b,c=require("../vendor/crypto.js"),d=require("../vendor/bigint.js"),e=require("./const.js"),f=require("./helpers.js"),g=require("./dsa.js")):(h.OTR.AKE=b,c=h.CryptoJS,d=h.BigInt,e=h.OTR.CONST,f=h.OTR.HLP,g=h.DSA);var i=d.str2bigInt(e.N,16),j=d.sub(i,d.str2bigInt("2",10));b.prototype={constructor:b,createKeys:function(a){var b=d.powMod(a,this.our_dh.privateKey,i),c=f.packMPI(b);this.ssid=f.mask(f.h2("\x00",c),0,64);var e=f.h2("",c);this.c=f.mask(e,0,128),this.c_prime=f.mask(e,128,128),this.m1=f.h2("",c),this.m2=f.h2("",c),this.m1_prime=f.h2("",c),this.m2_prime=f.h2("",c)},verifySignMac:function(b,d,e,h,i,j,k,l){var m=f.makeMac(d,e);if(!f.compare(b,m))return["MACs do not match."];var n=f.decryptAes(d.substring(4),h,l);n=f.splitype(["PUBKEY","INT","SIG"],n.toString(c.enc.Latin1));var o=a(i,j,n[0],n[1],k),p=g.parsePublic(n[0]),q=f.bits2bigInt(n[2].substring(0,20)),r=f.bits2bigInt(n[2].substring(20));return g.verify(p,o,q,r)?[null,f.readLen(n[1]),p]:["Cannot verify signature of m."]},makeM:function(b,e,g,h){var i=this.priv.packPublic(),j=f.packINT(this.our_keyid),k=a(this.our_dh.publicKey,b,i,j,e);k=this.priv.sign(k);var l=i+j;l+=d.bigInt2bits(k[0],20),l+=d.bigInt2bits(k[1],20),l=c.enc.Latin1.parse(l);var m=f.packData(f.encryptAes(l,g,f.packCtr(0))),n=f.makeMac(m,h);return m+n},akeSuccess:function(a){return f.debug.call(this.otr,"success"),d.equals(this.their_y,this.our_dh.publicKey)?this.otr.error("equal keys - we have a problem.",!0):(this.their_keyid!==this.otr.their_keyid&&this.their_keyid!==this.otr.their_keyid-1&&(this.otr.our_old_dh=this.our_dh,this.otr.their_y=this.their_y,this.otr.their_old_y=null,this.otr.their_keyid=this.their_keyid,this.otr.their_priv_pk=this.their_priv_pk,this.otr.sessKeys[0]=[new this.otr.DHSession(this.otr.our_dh,this.otr.their_y),null],this.otr.sessKeys[1]=[new this.otr.DHSession(this.otr.our_old_dh,this.otr.their_y),null]),this.otr.ssid=this.ssid,this.otr.transmittedRS=this.transmittedRS,this.otr_version=a,this.otr.authstate=e.AUTHSTATE_NONE,this.otr.msgstate=e.MSGSTATE_ENCRYPTED,this.r=null,this.myhashed=null,this.dhcommit=null,this.encrypted=null,this.hashed=null,this.otr.trigger("status",[e.STATUS_AKE_SUCCESS]),this.otr.sendStored(),void 0)},handleAKE:function(a){var b,g,h,i=a.version;switch(a.type){case"":if(f.debug.call(this.otr,"d-h key message"),a=f.splitype(["DATA","DATA"],a.msg),this.otr.authstate===e.AUTHSTATE_AWAITING_DHKEY){var k=f.readMPI(this.myhashed),l=f.readMPI(a[1]);if(d.greater(k,l)){h="",b=this.dhcommit;break}this.our_dh=this.otr.dh(),this.otr.authstate=e.AUTHSTATE_NONE,this.r=null,this.myhashed=null}else this.otr.authstate===e.AUTHSTATE_AWAITING_SIG&&(this.our_dh=this.otr.dh());this.otr.authstate=e.AUTHSTATE_AWAITING_REVEALSIG,this.encrypted=a[0].substring(4),this.hashed=a[1].substring(4),h="\n",b=f.packMPI(this.our_dh.publicKey);break;case"\n":if(f.debug.call(this.otr,"reveal signature message"),a=f.splitype(["MPI"],a.msg),this.otr.authstate!==e.AUTHSTATE_AWAITING_DHKEY){if(this.otr.authstate!==e.AUTHSTATE_AWAITING_SIG)return;if(!d.equals(this.their_y,f.readMPI(a[0])))return}if(this.otr.authstate=e.AUTHSTATE_AWAITING_SIG,this.their_y=f.readMPI(a[0]),!f.checkGroup(this.their_y,j))return this.otr.error("Illegal g^y.",!0);this.createKeys(this.their_y),h="",b=f.packMPI(this.r),b+=this.makeM(this.their_y,this.m1,this.c,this.m2),this.m1=null,this.m2=null,this.c=null;break;case"":if(f.debug.call(this.otr,"signature message"),this.otr.authstate!==e.AUTHSTATE_AWAITING_REVEALSIG)return;a=f.splitype(["DATA","DATA","MAC"],a.msg),this.r=f.readMPI(a[0]);var m=c.enc.Hex.parse(d.bigInt2str(this.r,16));m=c.enc.Latin1.stringify(m);var n=f.decryptAes(this.encrypted,m,f.packCtr(0));n=n.toString(c.enc.Latin1),this.their_y=f.readMPI(n);var o=c.SHA256(c.enc.Latin1.parse(n));return f.compare(this.hashed,o.toString(c.enc.Latin1))?f.checkGroup(this.their_y,j)?(this.createKeys(this.their_y),g=this.verifySignMac(a[2],a[1],this.m2,this.c,this.their_y,this.our_dh.publicKey,this.m1,f.packCtr(0)),g[0]?this.otr.error(g[0],!0):(this.their_keyid=g[1],this.their_priv_pk=g[2],b=this.makeM(this.their_y,this.m1_prime,this.c_prime,this.m2_prime),this.m1=null,this.m2=null,this.m1_prime=null,this.m2_prime=null,this.c=null,this.c_prime=null,this.sendMsg(i,"",b),this.akeSuccess(i),void 0)):this.otr.error("Illegal g^x.",!0):this.otr.error("Hashed g^x does not match.",!0);case"":if(f.debug.call(this.otr,"data message"),this.otr.authstate!==e.AUTHSTATE_AWAITING_SIG)return;return a=f.splitype(["DATA","MAC"],a.msg),g=this.verifySignMac(a[1],a[0],this.m2_prime,this.c_prime,this.their_y,this.our_dh.publicKey,this.m1_prime,f.packCtr(0)),g[0]?this.otr.error(g[0],!0):(this.their_keyid=g[1],this.their_priv_pk=g[2],this.m1_prime=null,this.m2_prime=null,this.c_prime=null,this.transmittedRS=!0,this.akeSuccess(i),void 0);default:return}this.sendMsg(i,h,b)},sendMsg:function(a,b,c){var d=a+b,g=a===e.OTR_VERSION_3;return g&&(f.debug.call(this.otr,"instance tags"),d+=this.otr.our_instance_tag,d+=this.otr.their_instance_tag),d+=c,d=f.wrapMsg(d,this.otr.fragment_size,g,this.otr.our_instance_tag,this.otr.their_instance_tag),d[0]?this.otr.error(d[0]):(this.otr._sendMsg(d[1],!0),void 0)},initiateAKE:function(a){f.debug.call(this.otr,"d-h commit message"),this.otr.trigger("status",[e.STATUS_AKE_INIT]),this.otr.authstate=e.AUTHSTATE_AWAITING_DHKEY;var b=f.packMPI(this.our_dh.publicKey);b=c.enc.Latin1.parse(b),this.r=d.randBigInt(128);var g=c.enc.Hex.parse(d.bigInt2str(this.r,16));g=c.enc.Latin1.stringify(g),this.myhashed=c.SHA256(b),this.myhashed=f.packData(this.myhashed.toString(c.enc.Latin1)),this.dhcommit=f.packData(f.encryptAes(b,g,f.packCtr(0))),this.dhcommit+=this.myhashed,this.sendMsg(a,"",this.dhcommit)}}}.call(this),function(){"use strict";function a(b){return this instanceof a?(this.version=1,this.our_fp=b.our_fp,this.their_fp=b.their_fp,this.ssid=b.ssid,this.debug=!!b.debug,this.init(),void 0):new a(b)}var b,c,d,e,f,g=this;"undefined"!=typeof module&&module.exports?(module.exports=a,b=require("../vendor/crypto.js"),c=require("../vendor/bigint.js"),d=require("../vendor/eventemitter.js"),e=require("./const.js"),f=require("./helpers.js")):(g.OTR.SM=a,b=g.CryptoJS,c=g.BigInt,d=g.EventEmitter,e=g.OTR.CONST,f=g.OTR.HLP);var h=c.str2bigInt(e.G,10),i=c.str2bigInt(e.N,16),j=c.sub(i,c.str2bigInt("2",10)),k=c.sub(i,c.str2bigInt("1",10));c.divInt_(k,2),f.extend(a,d),a.prototype.init=function(){this.smpstate=e.SMPSTATE_EXPECT1,this.secret=null},a.prototype.makeSecret=function(a,c){var d=b.algo.SHA256.create();d.update(b.enc.Latin1.parse(f.packBytes(this.version,1))),d.update(b.enc.Hex.parse(a?this.our_fp:this.their_fp)),d.update(b.enc.Hex.parse(a?this.their_fp:this.our_fp)),d.update(b.enc.Latin1.parse(this.ssid)),d.update(b.enc.Latin1.parse(c));var e=d.finalize();this.secret=f.bits2bigInt(e.toString(b.enc.Latin1))},a.prototype.makeG2s=function(){this.a2=f.randomExponent(),this.a3=f.randomExponent(),this.g2a=c.powMod(h,this.a2,i),this.g3a=c.powMod(h,this.a3,i),f.checkGroup(this.g2a,j)&&f.checkGroup(this.g3a,j)||this.makeG2s()},a.prototype.computeGs=function(a,b){this.g2=c.powMod(a,this.a2,i),this.g3=c.powMod(b,this.a3,i)},a.prototype.computePQ=function(a){this.p=c.powMod(this.g3,a,i),this.q=f.multPowMod(h,a,this.g2,this.secret,i)},a.prototype.computeR=function(){this.r=c.powMod(this.QoQ,this.a3,i)},a.prototype.computeRab=function(a){return c.powMod(a,this.a3,i)},a.prototype.computeC=function(a,b){return f.smpHash(a,c.powMod(h,b,i))},a.prototype.computeD=function(a,b,d){return c.subMod(a,c.multMod(b,d,k),k)},a.prototype.handleSM=function(a){var b,d,g,k,l,m,n,o,p,q,r,s,t,u,v={2:e.SMPSTATE_EXPECT1,3:e.SMPSTATE_EXPECT2,4:e.SMPSTATE_EXPECT3,5:e.SMPSTATE_EXPECT4,7:e.SMPSTATE_EXPECT1};if(6===a.type)return this.init(),this.trigger("trust",[!1]),void 0;if(this.smpstate!==v[a.type])return this.abort();switch(this.smpstate){case e.SMPSTATE_EXPECT1:f.debug.call(this,"smp tlv 2");var w,x;return 7===a.type&&(w=a.msg.indexOf("\x00"),x=a.msg.substring(0,w),a.msg=a.msg.substring(w+1)),t=f.readLen(a.msg.substr(0,4)),6!==t?this.abort():(a=f.unpackMPIs(6,a.msg.substring(4)),f.checkGroup(a[0],j)&&f.checkGroup(a[3],j)?f.ZKP(1,a[1],f.multPowMod(h,a[2],a[0],a[1],i))?f.ZKP(2,a[4],f.multPowMod(h,a[5],a[3],a[4],i))?(this.g3ao=a[3],this.makeG2s(),d=f.randomExponent(),g=f.randomExponent(),this.c2=this.computeC(3,d),this.c3=this.computeC(4,g),this.d2=this.computeD(d,this.a2,this.c2),this.d3=this.computeD(g,this.a3,this.c3),this.computeGs(a[0],a[3]),this.smpstate=e.SMPSTATE_EXPECT0,this.trigger("question",[x]),void 0):this.abort():this.abort():this.abort());case e.SMPSTATE_EXPECT2:if(f.debug.call(this,"smp tlv 3"),t=f.readLen(a.msg.substr(0,4)),11!==t)return this.abort();if(a=f.unpackMPIs(11,a.msg.substring(4)),!(f.checkGroup(a[0],j)&&f.checkGroup(a[3],j)&&f.checkGroup(a[6],j)&&f.checkGroup(a[7],j)))return this.abort();if(!f.ZKP(3,a[1],f.multPowMod(h,a[2],a[0],a[1],i)))return this.abort();if(!f.ZKP(4,a[4],f.multPowMod(h,a[5],a[3],a[4],i)))return this.abort();if(this.g3ao=a[3],this.computeGs(a[0],a[3]),l=f.multPowMod(this.g3,a[9],a[6],a[8],i),m=f.multPowMod(h,a[9],this.g2,a[10],i),m=c.multMod(m,c.powMod(a[7],a[8],i),i),!f.ZKP(5,a[8],l,m))return this.abort();var y=f.randomExponent();this.computePQ(y);var z=f.randomExponent(),A=f.randomExponent(),B=f.multPowMod(h,z,this.g2,A,i),C=f.smpHash(6,c.powMod(this.g3,z,i),B),D=this.computeD(z,y,C),E=this.computeD(A,this.secret,C);this.QoQ=c.divMod(this.q,a[7],i),this.PoP=c.divMod(this.p,a[6],i),this.computeR(),k=f.randomExponent(),q=c.powMod(this.QoQ,k,i),r=f.smpHash(7,c.powMod(h,k,i),q),s=this.computeD(k,this.a3,r),this.smpstate=e.SMPSTATE_EXPECT4,b=f.packINT(8)+f.packMPIs([this.p,this.q,C,D,E,this.r,r,s]),b=f.packTLV(4,b);break;case e.SMPSTATE_EXPECT3:if(f.debug.call(this,"smp tlv 4"),t=f.readLen(a.msg.substr(0,4)),8!==t)return this.abort();if(a=f.unpackMPIs(8,a.msg.substring(4)),!f.checkGroup(a[0],j)||!f.checkGroup(a[1],j)||!f.checkGroup(a[5],j))return this.abort();if(l=f.multPowMod(this.g3,a[3],a[0],a[2],i),m=f.multPowMod(h,a[3],this.g2,a[4],i),m=c.multMod(m,c.powMod(a[1],a[2],i),i),!f.ZKP(6,a[2],l,m))return this.abort();if(n=f.multPowMod(h,a[7],this.g3ao,a[6],i),this.QoQ=c.divMod(a[1],this.q,i),o=f.multPowMod(this.QoQ,a[7],a[5],a[6],i),!f.ZKP(7,a[6],n,o))return this.abort();this.computeR(),k=f.randomExponent(),q=c.powMod(this.QoQ,k,i),r=f.smpHash(8,c.powMod(h,k,i),q),s=this.computeD(k,this.a3,r),b=f.packINT(3)+f.packMPIs([this.r,r,s]),b=f.packTLV(5,b),p=this.computeRab(a[5]),u=!!c.equals(p,c.divMod(a[0],this.p,i)),this.trigger("trust",[u,"answered"]),this.init();break;case e.SMPSTATE_EXPECT4:return f.debug.call(this,"smp tlv 5"),t=f.readLen(a.msg.substr(0,4)),3!==t?this.abort():(a=f.unpackMPIs(3,a.msg.substring(4)),f.checkGroup(a[0],j)?(n=f.multPowMod(h,a[2],this.g3ao,a[1],i),o=f.multPowMod(this.QoQ,a[2],a[0],a[1],i),f.ZKP(8,a[1],n,o)?(p=this.computeRab(a[0]),u=!!c.equals(p,this.PoP),this.trigger("trust",[u,"asked"]),this.init(),void 0):this.abort()):this.abort())}this.sendMsg(b)},a.prototype.sendMsg=function(a){this.trigger("send",[this.ssid,"\x00"+a])},a.prototype.rcvSecret=function(a,b){f.debug.call(this,"receive secret");var c,d=!1;this.smpstate===e.SMPSTATE_EXPECT0?c=this.answer:(c=this.initiate,d=!0),this.makeSecret(d,a),c.call(this,b)},a.prototype.answer=function(){f.debug.call(this,"smp answer");var a=f.randomExponent();this.computePQ(a);var b=f.randomExponent(),d=f.randomExponent(),g=f.multPowMod(h,b,this.g2,d,i),j=f.smpHash(5,c.powMod(this.g3,b,i),g),k=this.computeD(b,a,j),l=this.computeD(d,this.secret,j);this.smpstate=e.SMPSTATE_EXPECT3;var m=f.packINT(11)+f.packMPIs([this.g2a,this.c2,this.d2,this.g3a,this.c3,this.d3,this.p,this.q,j,k,l]);this.sendMsg(f.packTLV(3,m))},a.prototype.initiate=function(a){f.debug.call(this,"smp initiate"),this.smpstate!==e.SMPSTATE_EXPECT1&&this.abort(),this.makeG2s();var b=f.randomExponent(),c=f.randomExponent();this.c2=this.computeC(1,b),this.c3=this.computeC(2,c),this.d2=this.computeD(b,this.a2,this.c2),this.d3=this.computeD(c,this.a3,this.c3),this.smpstate=e.SMPSTATE_EXPECT2;var d="",g=2;a&&(d+=a,d+="\x00",g=7),d+=f.packINT(6)+f.packMPIs([this.g2a,this.c2,this.d2,this.g3a,this.c3,this.d3]),this.sendMsg(f.packTLV(g,d))},a.prototype.abort=function(){this.init(),this.sendMsg(f.packTLV(6,"")),this.trigger("abort")}}.call(this),function(){"use strict";function a(b){if(!(this instanceof a))return new a(b);if(b=b||{},b.priv&&!(b.priv instanceof l))throw new Error("Requires long-lived DSA key.");if(this.priv=b.priv?b.priv:new l,this.fragment_size=b.fragment_size||0,this.fragment_size<0)throw new Error("Fragment size must be a positive integer.");if(this.send_interval=b.send_interval||0,this.send_interval<0)throw new Error("Send interval must be a positive integer.");this.outgoing=[],this.our_instance_tag=b.instance_tag||a.makeInstanceTag(),this.debug=!!b.debug,this.smw=b.smw,this.init();var c=this;["sendMsg","receiveMsg"].forEach(function(a){c[a]=c[a].bind(c)}),d.call(this)}var b,c,d,e,f,g,h,i,j,k,l,m=this;"undefined"!=typeof module&&module.exports?(module.exports=a,b=require("../vendor/crypto.js"),c=require("../vendor/bigint.js"),d=require("../vendor/eventemitter.js"),f=require("path").join(__dirname,"/sm-webworker.js"),g=require("./const.js"),h=require("./helpers.js"),i=require("./parse.js"),j=require("./ake.js"),k=require("./sm.js"),l=require("./dsa.js"),a.CONST=g):(Object.keys(m.OTR).forEach(function(b){a[b]=m.OTR[b]}),m.OTR=a,b=m.CryptoJS,c=m.BigInt,d=m.EventEmitter,e=m.Worker,f="sm-webworker.js",g=a.CONST,h=a.HLP,i=a.Parse,j=a.AKE,k=a.SM,l=m.DSA);var n=c.str2bigInt(g.G,10),o=c.str2bigInt(g.N,16),p=Math.pow(2,53)-1,q=Math.pow(2,31)-1;h.extend(a,d),a.prototype.init=function(){this.msgstate=g.MSGSTATE_PLAINTEXT,this.authstate=g.AUTHSTATE_NONE,this.ALLOW_V2=!0,this.ALLOW_V3=!0,this.REQUIRE_ENCRYPTION=!1,this.SEND_WHITESPACE_TAG=!1,this.WHITESPACE_START_AKE=!1,this.ERROR_START_AKE=!1,i.initFragment(this),this.their_y=null,this.their_old_y=null,this.their_keyid=0,this.their_priv_pk=null,this.their_instance_tag="\x00\x00\x00\x00",this.our_dh=this.dh(),this.our_old_dh=this.dh(),this.our_keyid=2,this.sessKeys=[new Array(2),new Array(2)],this.storedMgs=[],this.oldMacKeys=[],this.sm=null,this._akeInit(),this.receivedPlaintext=!1},a.prototype._akeInit=function(){this.ake=new j(this),this.transmittedRS=!1,this.ssid=null},a.prototype._SMW=function(a,b){this.otr=a;var d={path:f,seed:c.getSeed};"object"==typeof a.smw&&Object.keys(a.smw).forEach(function(b){d[b]=a.smw[b]}),"undefined"!=typeof module&&module.exports&&(e=require("webworker-threads").Worker),this.worker=new e(d.path);var g=this;this.worker.onmessage=function(a){var b=a.data;b&&g.trigger(b.method,b.args)},this.worker.postMessage({type:"seed",seed:d.seed(),imports:d.imports}),this.worker.postMessage({type:"init",reqs:b})},h.extend(a.prototype._SMW,d),["handleSM","rcvSecret","abort"].forEach(function(b){a.prototype._SMW.prototype[b]=function(){this.worker.postMessage({type:"method",method:b,args:Array.prototype.slice.call(arguments,0)})}}),a.prototype._smInit=function(){var a={ssid:this.ssid,our_fp:this.priv.fingerprint(),their_fp:this.their_priv_pk.fingerprint(),debug:this.debug};
this.smw?(this.sm&&this.sm.worker.terminate(),this.sm=new this._SMW(this,a)):this.sm=new k(a);var b=this;["trust","abort","question"].forEach(function(a){b.sm.on(a,function(){b.trigger("smp",[a].concat(Array.prototype.slice.call(arguments)))})}),this.sm.on("send",function(a,c){b.ssid===a&&b._sendMsg(c)})},a.prototype.io=function(a){this.outgoing=this.outgoing.concat(a);var b=this;!function c(a){if(!a){if(!b.outgoing.length)return;var d=b.outgoing.shift();b.trigger("io",[d])}setTimeout(c,a?0:b.send_interval)}(!0)},a.prototype.dh=function(){var a={privateKey:c.randBigInt(320)};return a.publicKey=c.powMod(n,a.privateKey,o),a},a.prototype.DHSession=function r(a,d){if(!(this instanceof r))return new r(a,d);var e=c.powMod(d,a.privateKey,o),f=h.packMPI(e);this.id=h.mask(h.h2("\x00",f),0,64);var g=c.greater(a.publicKey,d),i=g?"":"",j=g?"":"";this.sendenc=h.mask(h.h1(i,f),0,128),this.sendmac=b.SHA1(b.enc.Latin1.parse(this.sendenc)),this.sendmac=this.sendmac.toString(b.enc.Latin1),this.sendmacused=!1,this.rcvenc=h.mask(h.h1(j,f),0,128),this.rcvmac=b.SHA1(b.enc.Latin1.parse(this.rcvenc)),this.rcvmac=this.rcvmac.toString(b.enc.Latin1),this.rcvmacused=!1,this.extra_symkey=h.h2("Ã¿",f),this.send_counter=0,this.rcv_counter=0},a.prototype.rotateOurKeys=function(){var a=this;this.sessKeys[1].forEach(function(b){b&&b.sendmacused&&a.oldMacKeys.push(b.sendmac),b&&b.rcvmacused&&a.oldMacKeys.push(b.rcvmac)}),this.our_old_dh=this.our_dh,this.our_dh=this.dh(),this.our_keyid+=1,this.sessKeys[1][0]=this.sessKeys[0][0],this.sessKeys[1][1]=this.sessKeys[0][1],this.sessKeys[0]=[this.their_y?new this.DHSession(this.our_dh,this.their_y):null,this.their_old_y?new this.DHSession(this.our_dh,this.their_old_y):null]},a.prototype.rotateTheirKeys=function(a){this.their_keyid+=1;var b=this;this.sessKeys.forEach(function(a){a[1]&&a[1].sendmacused&&b.oldMacKeys.push(a[1].sendmac),a[1]&&a[1].rcvmacused&&b.oldMacKeys.push(a[1].rcvmac)}),this.their_old_y=this.their_y,this.sessKeys[0][1]=this.sessKeys[0][0],this.sessKeys[1][1]=this.sessKeys[1][0],this.their_y=a,this.sessKeys[0][0]=new this.DHSession(this.our_dh,this.their_y),this.sessKeys[1][0]=new this.DHSession(this.our_old_dh,this.their_y)},a.prototype.prepareMsg=function(a,c){if(this.msgstate!==g.MSGSTATE_ENCRYPTED||0===this.their_keyid)return this.error("Not ready to encrypt.");var d=this.sessKeys[1][0];if(d.send_counter>=p)return this.error("Should have rekeyed by now.");d.send_counter+=1;var e=h.packCtr(d.send_counter),f=this.ake.otr_version+"",i=this.ake.otr_version===g.OTR_VERSION_3;if(i&&(f+=this.our_instance_tag,f+=this.their_instance_tag),f+="\x00",f+=h.packINT(this.our_keyid-1),f+=h.packINT(this.their_keyid),f+=h.packMPI(this.our_dh.publicKey),f+=e.substring(0,8),Math.ceil(a.length/8)>=q)return this.error("Message is too long.");var j=h.encryptAes(b.enc.Latin1.parse(a),d.sendenc,e);return f+=h.packData(j),f+=h.make1Mac(f,d.sendmac),f+=h.packData(this.oldMacKeys.splice(0).join("")),d.sendmacused=!0,f=h.wrapMsg(f,this.fragment_size,i,this.our_instance_tag,this.their_instance_tag),f[0]?this.error(f[0]):(c&&this.trigger("file",["send",d.extra_symkey,c]),f[1])},a.prototype.handleDataMsg=function(a){var c=a.version+a.type;this.ake.otr_version===g.OTR_VERSION_3&&(c+=a.instance_tags);var d=["BYTE","INT","INT","MPI","CTR","DATA","MAC","DATA"];a=h.splitype(d,a.msg);var e=""===a[0];if(this.msgstate!==g.MSGSTATE_ENCRYPTED||8!==a.length)return e||this.error("Received an unreadable encrypted message.",!0),void 0;var f=this.our_keyid-h.readLen(a[2]),i=this.their_keyid-h.readLen(a[1]);if(0>f||f>1)return e||this.error("Not of our latest keys.",!0),void 0;if(0>i||i>1)return e||this.error("Not of your latest keys.",!0),void 0;var j=i?this.their_old_y:this.their_y;if(1===i&&!j)return e||this.error("Do not have that key."),void 0;var k=this.sessKeys[f][i],l=h.unpackCtr(a[4]);if(l<=k.rcv_counter)return e||this.error("Counter in message is not larger."),void 0;k.rcv_counter=l,c+=a.slice(0,6).join("");var m=h.make1Mac(c,k.rcvmac);if(!h.compare(a[6],m))return e||this.error("MACs do not match."),void 0;k.rcvmacused=!0;var n=h.decryptAes(a[5].substring(4),k.rcvenc,h.padCtr(a[4]));n=n.toString(b.enc.Latin1),f||this.rotateOurKeys(),i||this.rotateTheirKeys(h.readMPI(a[3]));var o=n.indexOf("\x00");return~o&&(this.handleTLVs(n.substring(o+1),k),n=n.substring(0,o)),n=b.enc.Latin1.parse(n),n.toString(b.enc.Utf8)},a.prototype.handleTLVs=function(a,c){for(var d,e,f;a.length&&(d=h.unpackSHORT(a.substr(0,2)),e=h.unpackSHORT(a.substr(2,2)),f=a.substr(4,e),!(f.length<e));){switch(d){case 1:this.msgstate=g.MSGSTATE_FINISHED,this.trigger("status",[g.STATUS_END_OTR]);break;case 2:case 3:case 4:case 5:case 6:case 7:if(this.msgstate!==g.MSGSTATE_ENCRYPTED)return this.sm&&this.sm.abort(),void 0;this.sm||this._smInit(),this.sm.handleSM({msg:f,type:d});break;case 8:f=f.substring(4),f=b.enc.Latin1.parse(f),f=f.toString(b.enc.Utf8),this.trigger("file",["receive",c.extra_symkey,f])}a=a.substring(4+e)}},a.prototype.smpSecret=function(a,b){return this.msgstate!==g.MSGSTATE_ENCRYPTED?this.error("Must be encrypted for SMP."):"string"!=typeof a||a.length<1?this.error("Secret is required."):(this.sm||this._smInit(),this.sm.rcvSecret(a,b),void 0)},a.prototype.sendQueryMsg=function(){var a={},b=g.OTR_TAG;this.ALLOW_V2&&(a["2"]=!0),this.ALLOW_V3&&(a["3"]=!0);var c=Object.keys(a);c.length&&(b+="v",c.forEach(function(a){"1"!==a&&(b+=a)}),b+="?"),this._sendMsg(b,!0),this.trigger("status",[g.STATUS_SEND_QUERY])},a.prototype.sendMsg=function(a){(this.REQUIRE_ENCRYPTION||this.msgstate!==g.MSGSTATE_PLAINTEXT)&&(a=b.enc.Utf8.parse(a),a=a.toString(b.enc.Latin1)),this._sendMsg(a)},a.prototype._sendMsg=function(a,b){if(!b)switch(this.msgstate){case g.MSGSTATE_PLAINTEXT:if(this.REQUIRE_ENCRYPTION)return this.storedMgs.push(a),this.sendQueryMsg(),void 0;this.SEND_WHITESPACE_TAG&&!this.receivedPlaintext&&(a+=g.WHITESPACE_TAG,this.ALLOW_V3&&(a+=g.WHITESPACE_TAG_V3),this.ALLOW_V2&&(a+=g.WHITESPACE_TAG_V2));break;case g.MSGSTATE_FINISHED:return this.storedMgs.push(a),this.error("Message cannot be sent at this time."),void 0;default:a=this.prepareMsg(a)}a&&this.io(a)},a.prototype.receiveMsg=function(a){if(a=i.parseMsg(this,a)){switch(a.cls){case"error":return this.error(a.msg),void 0;case"ake":if(a.version===g.OTR_VERSION_3&&this.checkInstanceTags(a.instance_tags))return;return this.ake.handleAKE(a),void 0;case"data":if(a.version===g.OTR_VERSION_3&&this.checkInstanceTags(a.instance_tags))return;a.msg=this.handleDataMsg(a),a.encrypted=!0;break;case"query":this.msgstate===g.MSGSTATE_ENCRYPTED&&this._akeInit(),this.doAKE(a);break;default:(this.REQUIRE_ENCRYPTION||this.msgstate!==g.MSGSTATE_PLAINTEXT)&&this.error("Received an unencrypted message."),this.receivedPlaintext=!0,this.WHITESPACE_START_AKE&&a.ver.length>0&&this.doAKE(a)}a.msg&&this.trigger("ui",[a.msg,a.encrypted])}},a.prototype.checkInstanceTags=function(a){var b=h.readLen(a.substr(0,4)),c=h.readLen(a.substr(4,4));if(c&&c!==h.readLen(this.our_instance_tag))return!0;if(h.readLen(this.their_instance_tag)){if(h.readLen(this.their_instance_tag)!==b)return!0}else{if(100>b)return!0;this.their_instance_tag=h.packINT(b)}},a.prototype.doAKE=function(a){this.ALLOW_V3&&~a.ver.indexOf(g.OTR_VERSION_3)?this.ake.initiateAKE(g.OTR_VERSION_3):this.ALLOW_V2&&~a.ver.indexOf(g.OTR_VERSION_2)?this.ake.initiateAKE(g.OTR_VERSION_2):this.error("OTR conversation requested, but no compatible protocol version found.")},a.prototype.error=function(a,b){return b?(this.debug||(a="An OTR error has occurred."),a="?OTR Error:"+a,this._sendMsg(a,!0),void 0):(this.trigger("error",[a]),void 0)},a.prototype.sendStored=function(){var a=this;this.storedMgs.splice(0).forEach(function(b){a._sendMsg(b)})},a.prototype.sendFile=function(a){if(this.msgstate!==g.MSGSTATE_ENCRYPTED)return this.error("Not ready to encrypt.");if(this.ake.otr_version!==g.OTR_VERSION_3)return this.error("Protocol v3 required.");if(!a)return this.error("Please specify a filename.");var c=b.enc.Utf8.parse(a);if(c=c.toString(b.enc.Latin1),c.length>=65532)return this.error("filename is too long.");var d="\x00";d+="\x00\b",d+=h.packSHORT(4+c.length),d+="\x00\x00\x00",d+=c,d=this.prepareMsg(d,a),d&&this._sendMsg(d,!0)},a.prototype.endOtr=function(){this.msgstate===g.MSGSTATE_ENCRYPTED&&(this.sendMsg("\x00\x00\x00\x00"),this.sm&&(this.smw&&this.sm.worker.terminate(),this.sm=null)),this.msgstate=g.MSGSTATE_PLAINTEXT,this.receivedPlaintext=!1,this.trigger("status",[g.STATUS_END_OTR])},a.makeInstanceTag=function(){var b=c.randBigInt(32);return c.greater(c.str2bigInt("100",16),b)?a.makeInstanceTag():h.packINT(parseInt(c.bigInt2str(b,10),10))}}.call(this),{OTR:this.OTR,DSA:this.DSA}});